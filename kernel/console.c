#include <n7OS/console.h>
#include <inttypes.h>
#include <n7OS/cpu.h>

int ligneCourante = 2;
int colonneCourante = 0;
uint8_t *scr_tab = (uint8_t *)0xB8000;

int offset = 2; // Taille de l'en-tête en début de console

void console_poscurs(int ligne, int colonne)
{
    int position = 80 * ligne + colonne;

    uint8_t pFaible = position & 0xFF;      // extrait les 8 bits de poids faible
    uint8_t pFort = (position >> 8) & 0xFF; // décale de 8 bits vers la droite et extrait les 8 bits de poids fort

    outb(0xF, 0x3D4);     // Envoi de la commande 15
    outb(pFaible, 0x3D5); // Envoi de la valeur de poids faible de la position
    outb(0xE, 0x3D4);     // Envoi de la commande 14
    outb(pFort, 0x3D5);   // Envoi de la valeur de poids fort de la position
}

void scroll()
{
    // Boucle pour décaler toutes les lignes de 1 caractère vers le haut sauf les deux premières
    for (int position = 80 * offset; position < 80 * 24; position++)
    {
        scr_tab[position * 2] = scr_tab[position * 2 + 80 * 2]; // Le caractère prends la valeur qui était juste en dessous de lui
    }

    // Nettoyer la dernière ligne
    for (int position = 80 * 24; position < 80 * 25; position++)
    {
        scr_tab[position * 2] = ' ';
        scr_tab[position * 2 + 1] = 0x0F;
    }

    ligneCourante--;
}

void console_putchar(char c)
{
    if (c > 31 && c < 127)
    {
        // Affichage du caractère à l'écran
        int pos = (80 * ligneCourante + colonneCourante) * 2;
        // Appel scroll si besoin
        if (pos > 25 * 80 * 2)
        {
            scroll();
            pos = (80 * ligneCourante + colonneCourante) * 2;
        }

        scr_tab[pos] = c;
        scr_tab[pos + 1] = 0x0F; // Fond noir texte blanc
        colonneCourante++;
        if (colonneCourante == 80)
        {
            colonneCourante = 0;
            ligneCourante++;
        }
    }
    else if (c == '\n')
    {
        // Curseur au début de la ligne suivante
        colonneCourante = 0;
        ligneCourante++;
    }
    else if (c == '\b')
    {
        // Déplace le curseur d'une colonne en arrière
        if (colonneCourante > 0)
        {
            colonneCourante--;
        }
        else
        {
            colonneCourante = 79;
            ligneCourante--;
        }
    }
    else if (c == '\t')
    {
        // Ajoute un espace de 8 caractères
        colonneCourante += 8;
    }
    else if (c == '\f')
    {
        // Efface l'écran et reviens à la position 0 0
        console_clear();
    }
    else if (c == '\r')
    {
        // Déplace le caractère à la colonne 0 de la ligne courante
        colonneCourante = 0;
    }
}

void console_putbytes(const char *s, int len)
{
    for (int i = 0; i < len; i++)
    {
        console_putchar(s[i]);
    }
    console_poscurs(ligneCourante, colonneCourante);
}

void console_clear()
{
    for (int pos = 80 * offset; pos < 25 * 80 * 2; pos += 2) // On ne supprime pas les deux (offset) premières lignes
    {
        scr_tab[pos] = ' ';
        scr_tab[pos + 1] = 0x0F; // Fond noir texte noir
    }
    // Retour à la position 0
    ligneCourante = 2;
    colonneCourante = 0;
}

void console_init()
{
    // Nettoyage de la console
    for (int pos = 0; pos < 25 * 80 * 2; pos += 2)
    {
        scr_tab[pos] = ' ';
        scr_tab[pos + 1] = 0x0F; // Fond noir texte noir
    }
    ligneCourante = 0;
    console_putbytes("n7OS\t\t\t   Antonin Litschgy\n", 27);
    for (int i = 0; i < 80; i++)
    {
        console_putbytes("*", 1);
    }
}
