#include <n7OS/console.h>
#include <inttypes.h>
#include <n7OS/irq.h>
#include <n7OS/cpu.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

const int f_osc = 0x1234BD; // Fréquence de l'oscillateur
const int HORLOGE = 1000;   // Fréquence de l'horloge à générer (1kHz)
const int FREQUENCE = f_osc / HORLOGE;

extern void handler_timer();

int cmp_sys = 0; // Horloge système (en ms)

void afficher_horloge()
{
    int secondes = (cmp_sys / 1000) % 60;
    int minutes = (cmp_sys / (1000 * 60)) % 60;
    int heures = (cmp_sys / (1000 * 60 * 60)) % 24;

    uint8_t *scr_tab = (uint8_t *)0xB8000;

    scr_tab[72 * 2] = '0' + (heures / 10);
    scr_tab[72 * 2 + 1] = 0x0F;
    scr_tab[73 * 2] = '0' + (heures % 10);
    scr_tab[73 * 2 + 1] = 0x0F;
    scr_tab[74 * 2] = ':';
    scr_tab[74 * 2 + 1] = 0x0F;
    scr_tab[75 * 2] = '0' + (minutes / 10);
    scr_tab[75 * 2 + 1] = 0x0F;
    scr_tab[76 * 2] = '0' + (minutes % 10);
    scr_tab[76 * 2 + 1] = 0x0F;
    scr_tab[77 * 2] = ':';
    scr_tab[77 * 2 + 1] = 0x0F;
    scr_tab[78 * 2] = '0' + (secondes / 10);
    scr_tab[78 * 2 + 1] = 0x0F;
    scr_tab[79 * 2] = '0' + (secondes % 10);
    scr_tab[79 * 2 + 1] = 0x0F;
}

// L'action à effectuer toutes les secondes
void handler_timer_C()
{
    cmp_sys++;
    afficher_horloge();
    outb(0x20, 0x20); // Acquittement
}

void init_timer()
{
    outb(0x34, 0x43);             // Accès poids faible/fort au channel 0, générateur d'impulsion, fréquence en binaire
    outb(FREQUENCE & 0xFF, 0x40); // Affectation de la fréquence poids faible au channel 0
    outb(FREQUENCE >> 8, 0x40);   // Affectation de la fréquence poids fort au channel 1
    outb(inb(0x21) & 0xfe, 0x21); // Demasquage de l'interruption

    init_irq_entry(0x20, (uint32_t)handler_timer);
}
